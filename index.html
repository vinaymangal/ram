<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>जप माला | डिजिटल जाप साथी</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none; 
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        #deity-name-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            font-weight: bold;
            color: #ef4444; /* Red-500 */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            transition: font-size 0.3s ease, text-shadow 0.3s ease, color 0.3s ease;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        /* Mala Completion Glow Animation */
        .mala-glow {
            animation: glow-animation 1s ease-out;
        }
        @keyframes glow-animation {
            0% { color: #ef4444; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
            50% { color: #f59e0b; text-shadow: 0 0 25px #f59e0b, 0 0 10px #fde68a; }
            100% { color: #ef4444; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        }

        /* Simple toggle switch style */
        .toggle-bg:after {
            content: '';
            @apply absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition shadow-sm;
        }
        input:checked + .toggle-bg:after {
            @apply transform translate-x-full;
        }
        input:checked + .toggle-bg {
            @apply bg-green-500;
        }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 antialiased overflow-hidden">

    <div id="app-container" class="w-full h-[100dvh] flex">

        <!-- Sidebar / Controls -->
        <aside id="sidebar" class="absolute top-0 left-0 h-full w-72 bg-white shadow-lg p-4 flex flex-col z-20 transform -translate-x-full md:relative md:transform-none md:w-80">
            <!-- Sidebar Header -->
            <div class="flex justify-between items-center border-b pb-3 mb-3">
                <h2 class="text-xl font-bold text-orange-800" data-i18n="controlsTitle">Controls</h2>
                <button id="close-sidebar-btn" class="md:hidden p-1 rounded-full hover:bg-gray-200">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>

            <!-- Controls Content -->
            <div class="flex-grow overflow-y-auto pr-1">
                <div class="space-y-4">
                    <!-- Account -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2" data-i18n="account">Account</h3>
                        <div id="user-info-container" class="bg-gray-100 p-3 rounded-lg text-sm"></div>
                    </div>

                    <!-- Chanting Controls -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2" data-i18n="chantingControls">Chanting Controls</h3>
                        <div class="bg-gray-100 p-3 rounded-lg space-y-3">
                            <button id="toggle-blink-btn" class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition"></button>
                            <div>
                                <label for="deity-selector" class="block text-sm font-medium text-gray-600 mb-1" data-i18n="selectDeity">Deity</label>
                                <select id="deity-selector" class="w-full p-2 bg-white border border-gray-300 rounded-md"></select>
                            </div>
                            <div>
                                <label for="blink-speed-selector" class="block text-sm font-medium text-gray-600 mb-1" data-i18n="blinkSpeed">Blink Speed</label>
                                <select id="blink-speed-selector" class="w-full p-2 bg-white border border-gray-300 rounded-md">
                                    <option value="1000">1.0s</option>
                                    <option value="900">0.9s</option>
                                    <option value="800">0.8s</option>
                                    <option value="700">0.7s</option>
                                    <option value="600">0.6s</option>
                                    <option value="500">0.5s</option>
                                    <option value="400" selected>0.4s</option>
                                    <option value="300">0.3s</option>
                                    <option value="200">0.2s</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Appearance -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2" data-i18n="appearance">Appearance</h3>
                        <div class="bg-gray-100 p-3 rounded-lg space-y-3">
                             <div>
                                <label for="font-size-selector" class="block text-sm font-medium text-gray-600 mb-1" data-i18n="fontSize">Font Size</label>
                                <select id="font-size-selector" class="w-full p-2 bg-white border border-gray-300 rounded-md">
                                    <option value="30vmin" data-i18n="optSmall">Small</option>
                                    <option value="40vmin" selected data-i18n="optMedium">Medium</option>
                                    <option value="50vmin" data-i18n="optLarge">Large</option>
                                    <option value="60vmin" data-i18n="optXLarge">Extra Large</option>
                                </select>
                            </div>
                            <div>
                                <label for="bg-color-selector" class="block text-sm font-medium text-gray-600 mb-1" data-i18n="backgroundColor">Background Color</label>
                                <select id="bg-color-selector" class="w-full p-2 bg-white border border-gray-300 rounded-md"></select>
                            </div>
                             <div>
                                <label for="language-selector" class="block text-sm font-medium text-gray-600 mb-1" data-i18n="language">Language</label>
                                <select id="language-selector" class="w-full p-2 bg-white border border-gray-300 rounded-md">
                                    <option value="hi">हिन्दी</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                             <div class="flex items-center justify-between pt-1">
                                <label for="sound-toggle" class="text-sm font-medium text-gray-600" data-i18n="malaSound">Mala Sound</label>
                                <label for="sound-toggle" class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="sound-toggle" class="sr-only">
                                    <div class="toggle-bg bg-gray-200 border-2 border-transparent h-6 w-11 rounded-full"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- All-Time Stats -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2" data-i18n="allTimeStats">All-Time Stats</h3>
                        <div id="all-time-stats-container" class="bg-gray-100 p-3 rounded-lg text-sm space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer / Today's Stats -->
            <div class="border-t pt-3 mt-3 text-sm">
                <h3 class="font-semibold text-gray-700 mb-2 text-center" data-i18n="todaysStats">Today's Stats</h3>
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div class="bg-orange-100 p-2 rounded-lg">
                        <p class="font-medium text-orange-700" data-i18n="chantLabel">Chant</p>
                        <p id="current-count" class="text-2xl font-bold text-orange-900">0</p>
                    </div>
                    <div class="bg-amber-100 p-2 rounded-lg">
                        <p class="font-medium text-amber-700" data-i18n="malaLabel">Mala</p>
                        <p id="mala-count" class="text-2xl font-bold text-amber-900">0</p>
                    </div>
                </div>
                <div class="mt-2 text-center bg-gray-100 p-2 rounded-lg">
                    <p class="font-medium text-gray-600" data-i18n="totalChants">Grand Total Chants</p>
                    <p id="total-chants" class="text-xl font-bold text-gray-800">0</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow relative flex flex-col items-center justify-center">
            <!-- Hamburger Menu Button -->
            <button id="open-sidebar-btn" class="absolute top-4 left-4 z-10 p-2 rounded-full bg-white/70 backdrop-blur-sm md:hidden">
                <i class="ph-bold ph-list text-2xl"></i>
            </button>
            
            <div class="text-center absolute top-4">
                 <h1 class="text-xl font-bold text-gray-600" data-i18n="mainTitle">राम नाम खाता</h1>
                 <p class="text-sm text-gray-500" data-i18n="mainSubtitle">राम नाम बैंक में खाता खोलो, जप का खाता चालु</p>
            </div>

            <div id="deity-name-container">राम</div>
        </main>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
            <h3 class="text-lg font-bold text-red-600 mb-2">Firebase Authentication Error</h3>
            <p class="text-sm text-gray-700 mb-4">This website's domain is not authorized to use Firebase Authentication.</p>
            <p class="text-sm font-semibold text-gray-800">How to fix:</p>
            <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1 mt-2">
                <li>Go to your <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-500 hover:underline">Firebase Console</a>.</li>
                <li>Select project: <strong>ramnaam1</strong></li>
                <li>Go to <strong>Authentication</strong> > <strong>Settings</strong> tab.</li>
                <li>Under <strong>Authorized domains</strong>, click <strong>Add domain</strong>.</li>
                <li>Enter the domain where this app is running and click Add.</li>
            </ol>
            <button id="close-error-modal" class="mt-6 w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const DEITIES = [
            { id: 'ram', name_hi: 'श्री राम', name_en: 'Shri Ram', mantra_hi: 'राम', mantra_en: 'Ram' },
            { id: 'krishna', name_hi: 'श्री कृष्ण', name_en: 'Shri Krishna', mantra_hi: 'कृष्ण', mantra_en: 'Krishna' },
            { id: 'shiva', name_hi: 'भगवान शिव', name_en: 'Lord Shiva', mantra_hi: 'शिव', mantra_en: 'Shiva' },
            { id: 'hanuman', name_hi: 'हनुमान', name_en: 'Hanuman', mantra_hi: 'हनुमान', mantra_en: 'Hanuman' },
        ];
        
        const TRANSLATIONS = {
            'hi': {
                'controlsTitle': 'नियंत्रण', 'account': 'अकाउंट', 'chantingControls': 'जाप नियंत्रण', 'toggleBlinkStart': 'जाप शुरू करें', 'toggleBlinkStop': 'जाप रोकें', 'selectDeity': 'देवता', 'blinkSpeed': 'जाप गति', 'appearance': 'दिखावट', 'fontSize': 'अक्षर का आकार', 'optSmall': 'छोटा', 'optMedium': 'मध्यम', 'optLarge': 'बड़ा', 'optXLarge': 'अतिरिक्त बड़ा', 'backgroundColor': 'बैकग्राउंड का रंग', 'optLightOrange': 'हल्का नारंगी', 'optWhite': 'सफ़ेद', 'optLightGray': 'हल्का ग्रे', 'optLightBlue': 'हल्का नीला', 'language': 'भाषा', 'chantLabel': 'जाप', 'malaLabel': 'माला', 'totalChants': 'कुल जाप', 'signInPrompt': 'अपनी प्रगति सिंक करने के लिए साइन इन करें।', 'signInBtn': 'Google से साइन इन करें', 'signOutBtn': 'साइन आउट', 'mainTitle': 'राम नाम खाता', 'mainSubtitle': 'राम नाम बैंक में खाता खोलो, जप का खाता चालु', 'malaSound': 'माला ध्वनि', 'allTimeStats': 'कुल आँकड़े', 'todaysStats': 'आज के आँकड़े',
            },
            'en': {
                'controlsTitle': 'Controls', 'account': 'Account', 'chantingControls': 'Chanting Controls', 'toggleBlinkStart': 'Start Chanting', 'toggleBlinkStop': 'Stop Chanting', 'selectDeity': 'Deity', 'blinkSpeed': 'Blink Speed', 'appearance': 'Appearance', 'fontSize': 'Font Size', 'optSmall': 'Small', 'optMedium': 'Medium', 'optLarge': 'Large', 'optXLarge': 'Extra Large', 'backgroundColor': 'Background Color', 'optLightOrange': 'Light Orange', 'optWhite': 'White', 'optLightGray': 'Light Gray', 'optLightBlue': 'Light Blue', 'language': 'Language', 'chantLabel': 'Chant', 'malaLabel': 'Mala', 'totalChants': 'Grand Total Chants', 'signInPrompt': 'Sign in to sync your progress.', 'signInBtn': 'Sign in with Google', 'signOutBtn': 'Sign Out', 'mainTitle': 'Ram Naam Khata', 'mainSubtitle': 'Open an account in the Ram Naam bank, start your chanting account', 'malaSound': 'Mala Sound', 'allTimeStats': 'All-Time Stats', 'todaysStats': 'Today\'s Stats',
            }
        };

        /*
         * NOTE on Firebase Config Security:
         * The configuration details below are meant to be public. They act as identifiers for your
         * Firebase project, not as secret keys. Security for your data is handled by
         * Firebase Security Rules on the backend, not by hiding these client-side variables.
        */
        const firebaseConfig = {
            apiKey: "AIzaSyDX4Bm3HBOMTZ2E9f_pPUKykzANumG6Bpg",
            authDomain: "ramnaam1.firebaseapp.com",
            projectId: "ramnaam1",
            storageBucket: "ramnaam1.firebasestorage.app",
            messagingSenderId: "399389434845",
            appId: "1:399389434845:web:bf67b08826207481054c34"
        };
        
        let state = {
            user: null, isBlinking: true, currentDeityId: 'ram', history: {},
            settings: { language: 'hi', blinkSpeed: 400, fontSize: '40vmin', bgColor: 'bg-orange-50', soundEnabled: true }
        };
        let blinkInterval, wakeLock = null, wakeLockFailed = false, audioContext = null;

        const DOMElements = {
            html: document.documentElement, sidebar: document.getElementById('sidebar'),
            openSidebarBtn: document.getElementById('open-sidebar-btn'), closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            mainContent: document.getElementById('main-content'),
            deityNameContainer: document.getElementById('deity-name-container'), userInfoContainer: document.getElementById('user-info-container'),
            toggleBlinkBtn: document.getElementById('toggle-blink-btn'), deitySelector: document.getElementById('deity-selector'),
            blinkSpeedSelector: document.getElementById('blink-speed-selector'), fontSizeSelector: document.getElementById('font-size-selector'),
            bgColorSelector: document.getElementById('bg-color-selector'), languageSelector: document.getElementById('language-selector'),
            soundToggle: document.getElementById('sound-toggle'), currentCount: document.getElementById('current-count'),
            malaCount: document.getElementById('mala-count'), totalChants: document.getElementById('total-chants'),
            allTimeStatsContainer: document.getElementById('all-time-stats-container'), errorModal: document.getElementById('error-modal'),
            closeErrorModalBtn: document.getElementById('close-error-modal'),
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
        } catch (error) { console.error("Firebase not configured. App in offline mode.", error); }
        
        function translateUI() {
            const lang = state.settings.language;
            DOMElements.html.lang = lang;
            const t = TRANSLATIONS[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => { if (t[el.dataset.i18n]) el.textContent = t[el.dataset.i18n]; });
            DOMElements.toggleBlinkBtn.textContent = t[state.isBlinking ? 'toggleBlinkStop' : 'toggleBlinkStart'];
            DOMElements.bgColorSelector.innerHTML = `<option value="bg-orange-50">${t.optLightOrange}</option><option value="bg-white">${t.optWhite}</option><option value="bg-gray-100">${t.optLightGray}</option><option value="bg-blue-50">${t.optLightBlue}</option>`;
        }

        async function saveState() {
            const dataToSave = { history: state.history, settings: state.settings, currentDeityId: state.currentDeityId };
            if (state.user && db) { try { await setDoc(doc(db, 'users', state.user.uid), dataToSave); } catch (e) { console.error("Firebase save failed", e) } } 
            else { localStorage.setItem('japMalaState', JSON.stringify(dataToSave)); }
        }
        
        async function loadState(isLogin = false) {
            let localData = null;
            const localState = localStorage.getItem('japMalaState');
            if (localState) localData = JSON.parse(localState);

            let remoteData = null;
            if (state.user && db) {
                 try {
                    const docSnap = await getDoc(doc(db, 'users', state.user.uid));
                    if (docSnap.exists()) remoteData = docSnap.data();
                } catch(e) { console.error("Firebase load failed", e); }
            }
            
            if (isLogin && localData && localData.history) {
                // Merge local (guest) history into remote history upon login
                remoteData = mergeHistories(localData, remoteData);
                localStorage.removeItem('japMalaState'); // Clear local data after merge
            }

            const data = remoteData || localData;
            if (data) {
                state.history = data.history || {};
                state.settings = { ...state.settings, ...data.settings };
                state.currentDeityId = data.currentDeityId || 'ram';
            }
        }
        
        function mergeHistories(local, remote) {
            const remoteHistory = remote?.history || {};
            for (const date in local.history) {
                if (!remoteHistory[date]) remoteHistory[date] = {};
                for (const deityId in local.history[date]) {
                    if (!remoteHistory[date][deityId]) remoteHistory[date][deityId] = { chants: 0, malas: 0 };
                    remoteHistory[date][deityId].chants += local.history[date][deityId].chants;
                    remoteHistory[date][deityId].malas += local.history[date][deityId].malas;
                    // Recalculate malas from chants
                    let totalChants = remoteHistory[date][deityId].chants;
                    remoteHistory[date][deityId].malas += Math.floor(totalChants / 108);
                    remoteHistory[date][deityId].chants = totalChants % 108;
                }
            }
            return { ...remote, history: remoteHistory };
        }
        
        function getTodaysCount() {
            const today = new Date().toISOString().split('T')[0];
            if (!state.history[today]) state.history[today] = {};
            if (!state.history[today][state.currentDeityId]) state.history[today][state.currentDeityId] = { chants: 0, malas: 0 };
            return state.history[today][state.currentDeityId];
        }

        function calculateAllTimeStats() {
            const stats = {};
            DEITIES.forEach(d => { stats[d.id] = { chants: 0, malas: 0 }});
            for(const date in state.history) {
                for(const deityId in state.history[date]) {
                    if(stats[deityId]) {
                        stats[deityId].chants += state.history[date][deityId].chants;
                        stats[deityId].malas += state.history[date][deityId].malas;
                    }
                }
            }
            // Normalize chants to malas
            for(const deityId in stats) {
                const total = stats[deityId].chants;
                stats[deityId].malas += Math.floor(total / 108);
                stats[deityId].chants = total % 108;
            }
            return stats;
        }

        function render() {
            translateUI();
            const lang = state.settings.language;
            DOMElements.deitySelector.innerHTML = DEITIES.map(d => `<option value="${d.id}">${d['name_'+lang]}</option>`).join('');
            
            // Set control values from state
            DOMElements.languageSelector.value = state.settings.language;
            DOMElements.deitySelector.value = state.currentDeityId;
            DOMElements.blinkSpeedSelector.value = state.settings.blinkSpeed;
            DOMElements.fontSizeSelector.value = state.settings.fontSize;
            DOMElements.bgColorSelector.value = state.settings.bgColor;
            DOMElements.soundToggle.checked = state.settings.soundEnabled;
            document.body.className = `antialiased overflow-hidden ${state.settings.bgColor}`;

            const deity = DEITIES.find(d => d.id === state.currentDeityId);
            DOMElements.deityNameContainer.textContent = deity['mantra_' + lang];
            DOMElements.deityNameContainer.style.fontSize = state.settings.fontSize;
            
            const todaysCount = getTodaysCount();
            DOMElements.currentCount.textContent = todaysCount.chants;
            DOMElements.malaCount.textContent = todaysCount.malas;
            
            const allTimeStats = calculateAllTimeStats();
            const grandTotal = Object.values(allTimeStats).reduce((sum, d) => sum + d.chants + (d.malas * 108), 0);
            DOMElements.totalChants.textContent = grandTotal.toLocaleString();
            
            DOMElements.allTimeStatsContainer.innerHTML = DEITIES.map(d => {
                const stats = allTimeStats[d.id];
                const total = stats.chants + (stats.malas * 108);
                if (total === 0) return '';
                return `
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${d['name_'+lang]}</span>
                        <span class="font-bold text-gray-600">${total.toLocaleString()}</span>
                    </div>`;
            }).join('');

            renderUserInfo();
        }
        
        function renderUserInfo() {
             const lang = state.settings.language;
             const t = TRANSLATIONS[lang];
             if (state.user) {
                DOMElements.userInfoContainer.innerHTML = `<div class="flex items-center"><img src="${state.user.photoURL}" alt="User" class="w-10 h-10 rounded-full mr-3"><div class="flex-grow"><p class="font-semibold text-gray-800">${state.user.displayName}</p><button id="sign-out-button" class="text-xs text-red-500 hover:underline">${t.signOutBtn}</button></div></div>`;
                document.getElementById('sign-out-button').addEventListener('click', handleSignOut);
            } else {
                DOMElements.userInfoContainer.innerHTML = `<p class="text-xs text-gray-600 mb-2">${t.signInPrompt}</p><button id="sign-in-button" class="w-full bg-blue-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-600 transition text-sm">${t.signInBtn}</button>`;
                document.getElementById('sign-in-button').addEventListener('click', handleSignIn);
            }
        }

        function playBellSound() {
            if (!state.settings.soundEnabled) return;
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime); // C6
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
        }

        function blink() {
            const container = DOMElements.deityNameContainer;
            container.style.visibility = (container.style.visibility === 'hidden') ? 'visible' : 'hidden';
            if (container.style.visibility === 'visible') {
                const todaysCount = getTodaysCount();
                todaysCount.chants++;
                if (todaysCount.chants >= 108) {
                    todaysCount.malas++;
                    todaysCount.chants = 0;
                    playBellSound();
                    container.classList.add('mala-glow');
                    setTimeout(() => container.classList.remove('mala-glow'), 1000);
                }
                render(); saveState();
            }
        }
        
        async function updateBlinking() {
            clearInterval(blinkInterval);
            DOMElements.toggleBlinkBtn.textContent = TRANSLATIONS[state.settings.language][state.isBlinking ? 'toggleBlinkStop' : 'toggleBlinkStart'];
            
            if (state.isBlinking && document.visibilityState === 'visible') {
                blinkInterval = setInterval(blink, state.settings.blinkSpeed);
                if ('wakeLock' in navigator && !wakeLock && !wakeLockFailed) {
                    try { wakeLock = await navigator.wakeLock.request('screen'); } 
                    catch (err) { wakeLockFailed = true; console.warn(`Wake Lock failed: ${err.message}`); }
                }
            } else {
                if (wakeLock) { await wakeLock.release(); wakeLock = null; }
                DOMElements.deityNameContainer.style.visibility = 'visible';
            }
        }

        function handleToggleBlink() { state.isBlinking = !state.isBlinking; updateBlinking(); saveState(); }
        function handleVisibilityChange() { updateBlinking(); }
        
        function createHandler(key, isSetting = false) {
            return (e) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                if(isSetting) state.settings[key] = value; else state[key] = value;
                if (isSetting && key === 'blinkSpeed') updateBlinking();
                render(); saveState();
            }
        }
        
        async function handleSignIn() {
            if (!auth) return;
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (error) {
                if (error.code === 'auth/unauthorized-domain') DOMElements.errorModal.classList.remove('hidden');
                else console.error('Auth error:', error);
            }
        }

        function handleSignOut() { if (auth) signOut(auth); }

        async function init() {
            DOMElements.openSidebarBtn.addEventListener('click', () => DOMElements.sidebar.classList.remove('-translate-x-full'));
            DOMElements.closeSidebarBtn.addEventListener('click', () => DOMElements.sidebar.classList.add('-translate-x-full'));
            DOMElements.mainContent.addEventListener('click', () => { if (window.innerWidth < 768) DOMElements.sidebar.classList.add('-translate-x-full'); });
            DOMElements.closeErrorModalBtn.addEventListener('click', () => DOMElements.errorModal.classList.add('hidden'));
            
            DOMElements.toggleBlinkBtn.addEventListener('click', handleToggleBlink);
            DOMElements.deitySelector.addEventListener('change', createHandler('currentDeityId'));
            DOMElements.blinkSpeedSelector.addEventListener('change', createHandler('blinkSpeed', true));
            DOMElements.fontSizeSelector.addEventListener('change', createHandler('fontSize', true));
            DOMElements.bgColorSelector.addEventListener('change', createHandler('bgColor', true));
            DOMElements.languageSelector.addEventListener('change', createHandler('language', true));
            DOMElements.soundToggle.addEventListener('change', createHandler('soundEnabled', true));

            document.addEventListener('visibilitychange', handleVisibilityChange);

            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    const isLoggingIn = !state.user && user;
                    state.user = user ? { uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL } : null;
                    await loadState(isLoggingIn);
                    render();
                    updateBlinking();
                    if(isLoggingIn) saveState(); // Save merged state back to firebase
                });
            } else {
                await loadState(); render(); updateBlinking();
            }
        }

        init();
    </script>
</body>
</html>

